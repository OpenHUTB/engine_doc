<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">

<!-- Mirrored from docs.unrealengine.com/4.26/zh-CN/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Reference/Trace/ by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 17 Jan 2024 11:40:21 GMT -->
<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script src="../../../../../../Include/Javascript/common_zh-CN.js" type="text/javascript"></script>
	<script type="text/javascript">
		var time = new Date(0);
		var preview = false;
		var relativeHTMLPath = "https://docs.unrealengine.com/4.26/";
				var pageid = 0;
				var heroimage = "";
				var lang = "zh-CN";
				var basePath = document.location.pathname.substring(0, document.location.pathname.indexOf('/' + lang + '/') + lang.length + 1);
		document.write('<base href="' +  encodeURI(basePath) + '/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Reference/Trace/" />');
				var udnCSS = '../../../../../../Include/CSS/udn_public.css';
		var udnLangCSS = '';
				udnLangCSS = './../../../../../../Include/CSS/udn_public_CN.css">';
				var udnOverrideCSS = '../../../../../../Include/CSS/skin_overrides.css';
		var udnOverrideDarkCSS = '../../../../../../Include/CSS/skin_overrides_dark.css';
		var fancyboxCSS = '../../../../../../Include/CSS/jquery.fancybox.css';
		var jqueryuiCSS = '../../../../../../Include/CSS/jquery-ui.min.css';
		var qtipCSS = '../../../../../../Include/CSS/jquery.qtip.css';
		var prettifyCSS = '../../../../../../Include/CSS/prettify.css';
		var navbarCSS = '../../../../../../Include/CSS/navBar.css';
		var twentytwentyCSS = '../../../../../../Include/CSS/twentytwenty.css';
		var recommendationsCSS = '../../../../../../Include/CSS/jquery.recommendations.css';
	</script>
    <title>Trace | 虚幻引擎文档</title>
    	    <meta name=viewport content="width=device-width, initial-scale=1" />
	<meta http-equiv="Cache-control" content="no-store">
    <script  src="../../../../../../Include/Javascript/CustomEvent.js" type="text/javascript"></script>
    <script  src="../../../../../../Include/Javascript/jquery-3.4.0.min.js" type="text/javascript"></script>
    <script  src="../../../../../../Include/Javascript/udn.js" type="text/javascript"></script>
    <script  src="../../../../../../Include/Javascript/udn_extras.js" type="text/javascript"></script>
    <script  src="../../../../../../Include/Javascript/jquery-ui.min.js" type="text/javascript"></script>
	    <script  src="../../../../../../Include/Javascript/informational.js" type="text/javascript"></script>
	    <script  src="../../../../../../Include/Javascript/jquery.fancybox.pack.js" type="text/javascript"></script>
    <script  src="../../../../../../Include/Javascript/jquery.qtip.js" type="text/javascript"></script>
    <script  src="../../../../../../Include/Javascript/prettify.js" type="text/javascript"></script>
    <script  src="../../../../../../Include/Javascript/jquery.slimscroll.js" type="text/javascript"></script>
    <script  src="../../../../../../Include/Javascript/jquery.event.move.js" type="text/javascript"></script>
    <script  src="../../../../../../Include/Javascript/jquery.twentytwenty.js" type="text/javascript"></script>
    <script  src="../../../../../../Include/Javascript/lazysizes.min.js" type="text/javascript"></script>
	    <script  src="../../../../../../Include/Javascript/jquery.recommendations.js" type="text/javascript"></script>
	
    <link async rel="icon" href="../../../../../../../favicon.png" type="image/x-icon" />
    <link async rel="shortcut icon" href="../../../../../../../favicon.png" type="image/x-icon" />
    <link async href="../../../../../../Include/Images/touch_icon.png" rel="apple-touch-icon" />
    <link async href="../../../../../../Include/Images/touch_icon_114.png" sizes="114x114" rel="apple-touch-icon" />    
		<script  src="../../../../../../Include/Javascript/CollapsibleLists.js" type="text/javascript"></script>
	<script  src="../../../../../../Include/Javascript/navigationBarUI.js"></script>
	<script  src="../../../../../../Include/Javascript/navigationBar.js"></script>
		
	<link rel="alternate" href="https://docs.unrealengine.com/latest/en-US/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Reference/Trace/" hreflang="x-default" />
<link rel="alternate" href="https://docs.unrealengine.com/latest/zh-CN/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Reference/Trace/" hreflang="zh-CN" />
<link rel="alternate" href="https://docs.unrealengine.com/latest/ja/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Reference/Trace/" hreflang="ja" />
<link rel="alternate" href="https://docs.unrealengine.com/latest/ko/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Reference/Trace/" hreflang="ko" />

	<meta name="intsourcechangelist" content="15018255" />
<meta name="availability" content="Public" />
<meta name="title" content="Trace" />
<meta name="description" content="Trace是一种结构化的日志记录框架，用于跟踪正在运行的Unreal Insights流程中的仪表测量事件。" />
<meta name="type" content="reference" />
<meta name="version" content="4.26" />
<meta name="parent" content="TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Reference" />
<meta name="order" content="1" />
<meta name="keywords" content="Trace" />
<meta name="keywords" content="Unreal Insights" />
<meta name="crumbs" content="%ROOT%,TestingAndOptimization,TestingAndOptimization/PerformanceAndProfiling,TestingAndOptimization/PerformanceAndProfiling/UnrealInsights,TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Reference" />

	<meta name="twitter:card" content="summary_large_image" />
	<meta property="og:title" content="Trace" />
	<meta property="og:description" content="Trace是一种结构化的日志记录框架，用于跟踪正在运行的Unreal Insights流程中的仪表测量事件。" />
		<meta property="og:image" content="" />
	</head>
<body id="webbgThree" style="visibility: hidden;" onload="document.body.style.visibility='visible';">
			<script>window.__tracking_base = 'https://tracking.unrealengine.com/';</script>
	<script src="../../../../../../../../tracking.unrealengine.com/tracking.js" async></script>    <div id="webThree">
				<div id="page_head">

			<edc-navigation blackListLangCodes='["de-de","es-es","es-mx","fr-fr","it-it","pt-br","ru-ru","pl-pl","tr-tr"]' locale="zh-CN" ></edc-navigation>
						<div id="pagenav">
				<div class="crumbs" id="crumbs">
<span id="versionContainer">
	<span id="versionSelect" class="btn btn-version" onclick="ToggleMenu($('#versionMenu'), $(this));"></span>
	<div id="versionMenu">
		<div id="4_26" data-version="4.26" class="btn btn-select" onclick="createCookie('version', '4.26', 365);SwitchVersion('4.26');">Unreal Engine 4.26 Documentation</div>
		<div id="4_27" data-version="4.27" class="btn btn-select" onclick="createCookie('version', '4.27', 365);SwitchVersion('4.27');">Unreal Engine 4.27 Documentation</div>
		<div id="5_0" data-version="5.0" class="btn btn-select" onclick="createCookie('version', '5.0', 365);SwitchVersion('5.0');">Unreal Engine 5.0 Documentation</div>
		<div id="5_1" data-version="5.1" class="btn btn-select" onclick="createCookie('version', '5.1', 365);SwitchVersion('5.1');">Unreal Engine 5.1 Documentation</div>
		<div id="5_2" data-version="5.2" class="btn btn-select" onclick="createCookie('version', '5.2', 365);SwitchVersion('5.2');">Unreal Engine 5.2 Documentation</div>
		<div id="5_3" data-version="5.3" class="btn btn-select" onclick="createCookie('version', '5.3', 365);SwitchVersion('5.3');">Unreal Engine 5.3 Documentation</div>
	</div>
</span>
	<span class="separator">></span> <a id="parent_link" href="../../../../index.html">测试并优化你的内容</a>

	<span class="separator">></span> <a id="parent_link" href="../../../index.html">性能及分析</a>

	<span class="separator">></span> <a id="parent_link" href="../../index.html">Unreal Insights</a>

	<span class="separator">></span> <a id="parent_link" href="../index.html">Unreal Insights参考</a>

<span class="separator">></span> <span id="page">Trace</span>
</div>				<div id="pageNavRight">
								<!-- Start of Search -->
												<div id="search_container">
					<form name="bodySearch" method="get" action="https://www.unrealengine.com/zh-CN/bing-search" onsubmit="return validateSearch()">
						<input type="image" src="../../../../../../Include/Images/search_box_icon.png" class="searchbutton"/>
						<input type="hidden" name="filter" value="文档" />
						<input type="text" name="keyword" placeholder="搜索文档……" class="searchbox" autocomplete="off"/>
					</form>
				</div>
								<!-- End of Search -->
				<div id="skinContainer">
	<div id="skinSelect" class="btn btn-skin" onclick="ToggleMenu($('#skinMenu'), $(this));"></div>
	<div id="skinMenu">
		<div id="light" class="btn btn-select" onclick="createCookie('skin', 'light', 365);location.reload();">Light Theme</div>
		<div id="dark" class="btn btn-select" onclick="createCookie('skin', 'dark', 365);location.reload();">Dark Theme</div>
	</div>
</div>				</div>
			</div>
		</div>						<div id="navWrapper">
			<div id="nav-filter-container">
				<div id="nav-filter-inner">
					<form>
						<input type="text" placeholder="Filter pages..." id="nav-filter" onchange="clearTimeout(filterTimer); filterTimer = setTimeout(updateNavTreeFilter,250, this.value);if(this.value.length == 0){$('#filter-clear').hide();}else{$('#filter-clear').show();}" onkeypress="this.onchange();" onpaste="this.onchange();" oninput="this.onchange();" />
						<button class="close-icon" id="filter-clear" type="reset" onclick="clearTimeout(filterTimer); filterTimer = setTimeout(updateNavTreeFilter,250, '');$(this).hide();"></button>
					</form>
				</div>
			</div>
			<nav id="navPanel">
			</nav>
			<div id="navigation" title="Click to toggle navigation menu"><span>></span></div>
		</div>		
		<div id="splitter">
		</div>
				<div id="contentContainer">
										<div id="pagedefault">
				<div id="product-banner">
	<div id="product-logo"></div>
</div>				<div id="pagecontainer" style="padding-right:0px;">
					<!-- Start of Markdown converted page content -->
																				<div class="hero  ">
						<div class="imgContainer"><img src="#" /></div>						<div class="info">
							<div id="pageTitle">
								<h1 id="H1TitleId">Trace</h1>
							</div>	
							<h2 >Trace是一种结构化的日志记录框架，用于跟踪正在运行的Unreal Insights流程中的仪表测量事件。</h2>
							<div id="access">
								<div class="accessContainer">
																																			</div>
							</div>
						</div>
					</div>
																				<div id="maincol">
						<div class="togglesection" id="osContainer">
	<div class="normaltitle">
		<p>Choose your operating system:</p>
	</div><div class="toggleButtons">
		<div class="btn btn-default btn-toggle OS windows" id="windows" onclick="setSelector('OS', 'windows');">
			<p>Windows</p>
		</div>
		<div class="btn btn-default btn-toggle OS mac" id="mac" onclick="setSelector('OS', 'mac');">
			<p>macOS</p>
		</div>
		<div class="btn btn-default btn-toggle OS linux" id="linux" onclick="setSelector('OS', 'linux');">
			<p>Linux</p>
		</div>
	</div>
</div>																																				<div class="toc">
<div style="position:relative;">
    <div class="title">
    本页面的内容
    </div>
<div id="tocScroll">
    <ul>
	    		    			    <li id="">
	<p><a id="toc_link" href="#trace简介">Trace简介</a></p>
			<ul>
							<li id="">
	<p><a id="toc_link" href="#事件">事件</a></p>
	</li>					</ul>
	</li>		    			    <li id="">
	<p><a id="toc_link" href="#通道">通道</a></p>
			<ul>
							<li id="">
	<p><a id="toc_link" href="#分析">分析</a></p>
	</li>							<li id="">
	<p><a id="toc_link" href="#录制器/存储">录制器/存储</a></p>
	</li>					</ul>
	</li>		    			    <li id="">
	<p><a id="toc_link" href="#运行时细节">运行时细节</a></p>
			<ul>
							<li id="">
	<p><a id="toc_link" href="#普通事件">普通事件</a></p>
	</li>							<li id="">
	<p><a id="toc_link" href="#重要事件">重要事件</a></p>
	</li>							<li id="">
	<p><a id="toc_link" href="#工作线程">工作线程</a></p>
	</li>							<li id="">
	<p><a id="toc_link" href="#传输">传输</a></p>
	</li>							<li id="">
	<p><a id="toc_link" href="#命令控制/延迟连接">命令控制/延迟连接</a></p>
	</li>					</ul>
	</li>		    			    <li id="">
	<p><a id="toc_link" href="#杂项">杂项</a></p>
			<ul>
							<li id="">
	<p><a id="toc_link" href="#数组">数组</a></p>
	</li>							<li id="">
	<p><a id="toc_link" href="#附件">附件</a></p>
	</li>							<li id="">
	<p><a id="toc_link" href="#字符串">字符串</a></p>
	</li>							<li id="">
	<p><a id="toc_link" href="#限制">限制</a></p>
			<ul>
							<li id="">
	<p><a id="toc_link" href="#虚幻引擎4说明">虚幻引擎4说明</a></p>
	</li>					</ul>
	</li>					</ul>
	</li>		    	        </ul>
</div>
</div>
</div>
<p>Trace是一种结构化的日志记录框架，用于跟踪正在运行的流程中的仪表测量事件。此框架旨在生成高频跟踪事件的流，此类事件自我描述，可以轻松使用和共享。模块TraceLog和TraceAnalysis是构成该框架的基本模块。Unreal Insights是Trace的主要用户。
</p><h2 id="trace简介">Trace简介</h2>
<h3 id="事件">事件</h3>
<p>整个系统由多个元素组成，这些元素形成了从从运行时的发射到后续在分析期间的使用一条管线。系统的第一部分跟踪事件，定义如下： 
</p><pre class="prettyprint"><code>UE&#95;TRACE&#95;EVENT&#95;BEGIN(LoggerName, EventName&#91;, Flags&#93;)
    UE&#95;TRACE&#95;EVENT&#95;FIELD(Type, FieldName)
UE&#95;TRACE&#95;EVENT&#95;END()</code></pre>
<p><code>EventName</code> 和 <code>FieldName</code> 参数应该能够自我解释。事件按照"记录器"进行分组，是一种仅限于语义的概念，在分析跟踪流时有助于命名空间事件和简化订阅。可选的 <code>Flags</code> 可以修改事件的跟踪方式。
</p><div class="simpletable">
	<table >
	<caption></caption>
	<col align=""/>
	<col align=""/>
	<thead>
		<tr >

	<th rowspan="1" colspan="1" >
			<p>事件标记</p>
			</th>
	
	<th rowspan="1" colspan="1" >
			<p>说明</p>
			</th>
	
</tr>	</thead>
<tbody>
	<tr >

	<td rowspan="1" colspan="1" align="">
			<p>NoSync</p>
			</td>
	
	<td rowspan="1" colspan="1" align="">
			<p>默认情况下，事件与其他线程上要跟踪的事件同步。标记为"NoSync"的事件将跳过此同步；它们更小，可以更快地跟踪，但代价是在分析期间与其他线程不协调。</p>
			</td>
	
</tr><tr >

	<td rowspan="1" colspan="1" align="">
			<p>Important</p>
			</td>
	
	<td rowspan="1" colspan="1" align="">
			<p>某些事件仅发送一次，需要解释后续的跟踪事件（例如将名称映射到标识的整数）。此类事件标记为"important"，以便可以保留并在稍后发送它们。<div class="note">
	<p>此标记用于虚幻引擎5。</p>
</div></p>
			</td>
	
</tr></tbody>
</table>
</div><p>字段类型可以是标准的整数或浮点基元（例如unit32、浮点等），以及数组和字符串（请参见下文以了解后两者的更多信息）。不支持将嵌套结构/事件作为字段。
</p><p>事件通常在.cpp文件中进行全局范围的定义。如果需要从多个平移单元跟踪事件，则可以使用 <code>UE&#95;TRACE&#95;EVENT&#95;BEGIN&#95;&#91;EXTERN&#124;DEFINE&#93;</code> 对。
</p><p>运行时的事件日志记录方式如下： 
</p><pre class="prettyprint"><code>UE&#95;TRACE&#95;LOG(RainbowLogger, ZippyEvent, ItvChannel)
    &lt;&lt; ZippyEvent.Field0(Value0)
    &lt;&lt; ZippyEvent.Field1(BundleValue)
    &lt;&lt; ZippyEvent.Field2(Data, Num);
    &lt;&lt; ZippyEvent.Field3(String&#91;, Num&#93;);</code></pre>
<p>只要启用了信道"ItvChannel"，就会向跟踪流添加"RainbowLogger.ZippyEvent"事件。将值分配到字段时需要注意避免产生任何副作用，尤其是用于跟踪额外事件的字段，因为日志站点无法重新进入。
</p><p>跟踪事件时不会发生增量压缩或运行长度压缩。执行特定的 <code>UE&#95;TRACE&#95;LOG()</code> 调用时，所有已定义的字段即使并未写入，也仍会显示。。跟踪的事件基本上类似于 <code>#pragma pack(1)</code> -声明的结构体。明智的做法是，从战略角度思考如何充分利用这些位。
</p><p>旁注；使用宏加速的背后有两重考虑；若已知偏移量等细节，则编译时可以隐藏大量样板文件；其次，在上述情况下，trace关闭时，定义和日志站点编译为空，不会到处散落 <code>#if/end</code>。
</p><h2 id="通道">通道</h2>
<p>为了将事件流限制为用户感兴趣的内容，由此产生了信道的概念。这有助于关注需要重点观察的CPU和内存资源。可以按照以下方式轻松定义信道： 
</p><pre class="prettyprint"><code>UE&#95;TRACE&#95;CHANNEL(ItvChannel);</code></pre>
<p>对于更具体的用例，可以使用 <code>EXTERN/DEFINE</code> 对。默认情况下，信道将会被禁用并且必须通过 <code>-trace=itv</code> 命令行选项或 <code>Trace::ToggleChannel()</code> API明确启用。
</p><p>信道将覆盖按位OR运算符，以便它们与日志站点一同控制使用多个信道跟踪事件。如果"Itv"和"Bbc"信道均启用，<code>UE&#95;TRACE&#95;LOG(..., ItvChannel&#124;BbcChannel)</code> 将仅发射一个事件。思路敏捷的读者可能会感觉有些疑惑，这与按位OR的预期结果相反。
</p><h3 id="分析">分析</h3>
<p>现在我们已经定义了新事件，再加上启用了切断的信道，添加了一个或两个日志站点，我们将能够使用和分析事件。这是使用TraceAnalysis模块执行的。
</p><p>分析器是通过从 <code>IAnalyzer</code> 推导并实施两个主要方法创建的；用于订阅事件的 <code>OnAnalysisBegin()</code>，以及用于接收这些订阅的 <code>OnEvent()</code>。
</p><p>分析时如果遇到分析器已经订阅的事件，将会调用分析器的 <code>OnEvent()</code> 方法。对事件数据的访问是通过 <code>FEventContext.EventData.Get&#42;()</code> 方法完成的。此API反映跟踪流的自我描述性质 - 解释跟踪流时并不依赖二进制或运行时代码。每个接收的事件都具有关联的线程信息，以及（某些非常罕见的情况下）一些计时信息。
</p><p>在跟踪会话上运行分析是直接通过描述要使用的分析器和向创建的分析会话提供跟踪数据来进行的。
</p><pre class="prettyprint"><code>struct : IInDataStream { ... } TraceData;
FGeorgeAnalyzer GeorgeAnalyzer;
FAnalysisContext Context;
Context.AddAnalyzer(GeorgeAnalyzer);
FAnalysisProcessor Processor = Context.Process(TraceData)
Processor.Wait();</code></pre>
<div class="note">
	<p>虽然系统ID可用，但支配线程ID与系统线程ID不太相同。这是为了更好地防止在操作系统可能重用线程ID的情况下进行处理。因此系统ID预期会从一个线程重用到下一个。跟踪的ID则不会被重复使用，或者至少被认为不太可能出现这种问题。</p>
</div><h3 id="录制器/存储">录制器/存储</h3>
<p>TraceAnalysis 模块包括两个组件，这两个组件共同构成了接收、存储和检索跟踪数据的服务。该实现使用异步 IO，因此它可以轻松地扩展到许多客户端（主要是入站跟踪数据）。启动并运行一个存储是很直接的。
</p><pre class="prettyprint"><code>FStoreService::FDesc Desc = {
    StoreDir,     /&#42; directory path on disk &#42;/
    RecorderPort, /&#42; -1=off, 0=auto-assign &#42;/
    1,            /&#42; No. of IOCP threads &#42;/
};
auto Store = TUniquePtr&lt;FStoreService&gt;(FStoreService::Create(Desc));</code></pre>
<p>记录器在TCP端口上监听传入的跟踪（trace）。当某个运行时与记录器建立连接时，记录器与存储创建一个新的跟踪，并开始将接收到的数据中继到这个新的跟踪中。默认使用1980端口，但也可以要求操作系统分配一个暂时端口。
</p><p>存储器（Store）的主要作用是管理跟踪的目录。它允许创建新的跟踪，列举可用的跟踪，以及检索一个特定的跟踪数据。在上面构建了一个类似于REST的协议，用于与存储进行通信。该协议基于CBOR的互操作性。`FStoreClient`是这个协议的一个实现。
</p><pre class="prettyprint"><code>const auto&#42; Store = GetWellKnownTraceStoreServer();
if (auto Client = FStoreClient::Connect(Store-&gt;Ip, Store-&gt;Port))
{
    for (int i = 0, n = Client.GetTraceCount(); i &lt; n; ++i)
    {
        const auto&#42; Info = Client.GetTraceInfo(i);
        /&#42; ... &#42;/
    }
}</code></pre>
<p>记录器存储组件是可选的。你可以要求运行时跟踪到某个文件。或者根据情况，用Python写一个类似记录器的脚本，通过套接字（socket）来接收跟踪数据，这样会更方便。
</p><h2 id="运行时细节">运行时细节</h2>
<h3 id="普通事件">普通事件</h3>
<p>当某个事件在 <code>UE&#95;TRACE&#95;LOG()</code> 站点被跟踪到时，一个小型标头以及事件的字段值会被写入当前线程本地的一个缓冲区。这些 TLS 缓冲区大小适中，并以List形式连接在一起。Trace 的工作线程会遍历缓冲区list，发送已经提交的事件数据（因此是完整的、完全可见的）。
</p><p>使用TLS的好处是，它可以让跟踪线程不受彼此的影响（几乎是这样）。线程间的顺序对于某些事件类型具有重要意义，必须在分析跟踪数据时重建；例如分配和空闲事件，其中的地址可以得到复用。Trace使用一个以原子形式增量的整数进行同步；在每个事件之前使用一个24位的序列号。当然这是有代价的，所以可以选择不用。理想情况下，所有的事件类型都应该选择不采用同步（但也许不会以读取TSC为代价！）。
</p><h3 id="重要事件">重要事件</h3>
<p><div class="note">
	<p>这些功能适用于虚幻引擎5。</p>
</div>
</p><p>在UE5中又引入了一类名为 "重要（Important）" 的事件类型。这种类型的事件是针对那些只被跟踪一次，但（通常）需要解释其他后续跟踪数据的事件。它们需要用到不同的处理方式，因为这些事件很容易被遗漏（例如，断开连接然后重新连接到运行时的跟踪数据。重要事件需要在两个跟踪数据流中，但只在第一个数据流中被跟踪）。
</p><p>重要类型的事件会被写入所有线程共享的缓冲区。这里有两个原因：首先，这样能将它们与普通事件分开，从而避免因为解释和多路分解（demultiplex）跟踪数据而产生的复杂性。其次，这应该有助于降低内存使用，因为追踪的重要事件的总数应该是有限的。
</p><p>Trace的工作线程会轮询共享缓冲区中已提交的数据，并将其复制到储备缓冲区中，进行临时存储。随着重要事件库的不断扩充，数据以LZ4形式压缩并存储在缓存中。每次对跟踪数据进行新的连接时，都会发送这个缓存，以便确保重要事件不会丢失，并且位于数据流的开头位置。
</p><p>注意，重要事件在分析过程中没有相关的线程信息，因为所有与线程相关的上下文信息早已消失。
</p><h3 id="工作线程">工作线程</h3>
<p>工作线程用于从TSL和共享缓冲方案中收集跟踪的事件，压缩和缓存重要事件，处理命令控制通信，以及管理目标IO（套接字或文件）。此线程以固定的间隔运行，是自由线程（例如，不是作为引擎循环的一部分进行启动的作业或任务）。
</p><p>在某些情况下，可能不适合由工作线程使用和调度跟踪事件（在Linux上为叉取）。可以在初始化期间选择退出 <code>bUseWorkerThread</code>，这将默认为 <code>FPlatformProcess::SupportsMultithreading()</code>返回的值。禁用后，用户负责更新跟踪，以便通过 <code>Trace::Update()</code> 使用事件。请注意，低频更新将导致使用更多内存来缓冲跟踪的事件。通常，这全部是由Core的TraceAuxiliary来执行的。
</p><h3 id="传输">传输</h3>
<p>跟踪数据以数据包（packet）的形式发送，称为 "数据传输（Transport）"。每个数据包都有一个内部标识符作为前缀，表明事件来自哪个线程（如果是重要事件，则为零），以及一个大小数据。大多数数据包都是LZ4压缩的，那些不是LZ4压缩的数据包太小了，无法从中受益。
</p><p>这些数据包可以由运行时发送到两个地方：用 <code>-tracefile=</code> 参数发送到文件，或用 <code>Trace::WriteTo()</code> 程序化地发送到文件，或通过TCP套接字(<code>-tracehost=</code>/<code>Trace::SendTo()</code>)发送。默认的TCP端口是1980。
</p><p>在跟踪流的开头，还有一小段握手数据和一段非结构化的元数据，它们会一起发送。
</p><h3 id="命令控制/延迟连接">命令控制/延迟连接</h3>
<p>在某些情况下，类似Unreal Insights这样的工具可能会希望控制发送数据的跟踪系统。为此，运行时会运行一个基本的命令/控制服务器，它主要镜像了 <code>Trace::</code> 公共API。为此，运行时运行了一个基本的命令/控制服务器，它主要反映了`Trace::`公共API。TraceAnalysis中有一个简单类来协助通信。
</p><pre class="prettyprint"><code>FControlClient ControlClient;
if (ControlClient.Connect(Bungle.GetHostName())
{
    ControlClient.SendToggleChannel(L"ItvChannel", true);
    ControlClient.SendWriteTo(L"X:/Rainbow.utrace");
}</code></pre>
<p>这个简易服务器监听端口是1985（那是影视经典《回到未来》上映的年份）。注意，在默认情况下，端口会不断变化（hop about）。端口号嵌入在流送数据的元数据中，该元数据位于握手数据后面（通过TraceAnalysis的Recorder访问）。
</p><p>由于端口是一个比较常见的值（至少在默认情况下）， 所以可以延迟连接（late-connect）到正在运行的产品，并告诉它在某个地方开始跟踪数据。这就是所谓的延迟连接（late-connect）。
</p><h2 id="杂项">杂项</h2>
<h3 id="数组">数组</h3>
<h3 id="附件">附件</h3>
<p>早期的跟踪不支持可变长度的字段。此后引入了附件的概念，可以将不透明的二进制块附加到跟踪事件后面。不推荐使用附件，而是应该使用数组类型的字段，此类字段由于结构化而具有优势，在分析时能够反映出来。此外，附件支持还会产生成本，每个记录的事件都需要占用资源，因此在将来有可能变成选择性加入的组件，以优化此类支出。
</p><h3 id="字符串">字符串</h3>
<p>跟踪事件在声明带有 <code>UE&#95;TRACE&#95;EVENT&#95;FIELD()</code> 的事件的字段时使用 <code>Trace::AnsiString</code> 或 <code>Trace::WideString</code> 来支持字符串类型的字段。 
</p><pre class="prettyprint"><code>UE&#95;TRACE&#95;EVENT&#95;BEGIN(MyLogger, MyEvent)
    UE&#95;TRACE&#95;EVENT&#95;FIELD(Trace::AnsiString, MyFieldA)
    UE&#95;TRACE&#95;EVENT&#95;FIELD(Trace::WideString, MyFieldW)
UE&#95;TRACE&#95;EVENT&#95;END()</code></pre>
<p>字符串类型的字段在编写时与基元类型的字段基本相同，但有一些额外的要求；ASCII类型的字段将宽字符串自动截断成7位字符，提供可选的字符串长度（如果字符串长度已知，对性能尤其有帮助）。 
</p><pre class="prettyprint"><code>UE&#95;TRACE&#95;LOG(MyLogger, MyEvent)
    &lt;&lt; MyFieldA(AnAnsiBuffer, &#91;, ExplicitStringLen&#93;)
    &lt;&lt; MyFieldW(WideName)</code></pre>
<h3 id="限制">限制</h3>
<p>跟踪系统全局运行，每次只能跟踪一件事情。由于编辑器中的部分工具现在使用跟踪系统，编辑器不再自动连接和跟踪到正在运行的Unreal Insights。如果你希望分析编辑器，则在启动编辑器时必须提供 <code>-tracehost=127.0.0.1</code> 参数（或者根据项目的插件，在编辑器中提供 <code>trace.start</code>）。
</p><h4 id="虚幻引擎4说明">虚幻引擎4说明</h4>
<p>部分跟踪的事件是一次性的，它们仅能跟踪一次。向名称分配ID是常见情况，例如CPU事件的名称。遗憾的是，由于一次性跟踪事件中的上下文信息将会丢失，这就导致无法停止跟踪并会在随后重启该跟踪。此场景的常见特征是Unreal Insights中的"未知"CPU事件或线程。<code>trace.stop</code> 实际上不是真的停止，而是为了缓解这种限制而禁用信道。未来的引擎版本将采用"重要事件"概念。一次性事件将会放入缓存并在建立跟踪连接之后重新发送，因此可以无缝支持掉入/掉出分析工作流。</p>
																	</div>
					<!-- End of Markdown converted page content -->
				</div>
												<div id="pageTags">
				<div class="title">标签</div>
					<div>
					<div class="keyword_tag_filter"><a id="tag_link" href="../../../../../SiteIndex/index.html?tags=Trace">Trace</a></div>
<div class="keyword_tag_filter"><a id="tag_link" href="../../../../../SiteIndex/index.html?tags=Unreal%20Insights">Unreal Insights</a></div>
					</div>
				</div>
								<div id="recommendations"></div>			</div>
						<div id="footer"></div>									<div id="announcement">
			<div style="display:inline-block;margin:5px;">
				欢迎帮助改进虚幻引擎文档！请告诉我们该如何更好地为您服务。
			</div>
			<div style="margin:5px;display:inline-block;">
				<div class="btn action" style="margin-top:-6px;display:inline-block;" onclick="$('#announcement').hide();window.open('https://epicgames.questionpro.com/t/AP9dGZkjp4');createCookie('announcement-read', new Date().getTime(), 30);">填写问卷调查</div>
				<div class="btn btn-default" style="margin-top:-6px;display:inline-block;" onclick="$('#announcement').hide();createCookie('announcement-read', new Date().getTime(), 30);">取消</div>
			</div>
			<div class="btn-close" style="position:absolute;right:5px;top:10px;padding:3px;width:14px;height:14px;" onclick="$('#announcement').hide();"></div>
			</div>
					</div>
	</div></body>

<!-- Mirrored from docs.unrealengine.com/4.26/zh-CN/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Reference/Trace/ by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 17 Jan 2024 11:40:21 GMT -->
</html>
